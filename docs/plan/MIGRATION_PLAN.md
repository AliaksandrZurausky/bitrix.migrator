# Bitrix Migrator — план миграции (Cloud → Box) — ОБНОВЛЕННЫЙ

## 0. Цель и принципы
- Цель: разовая миграция данных из облачного Bitrix24 в коробочный Bitrix (CRM сущности + связи + таймлайн + задачи + рабочие группы + пользователи + структура + диск) без удаления данных в облаке.
- Основной принцип: миграция асинхронная, управляемая (start/pause/resume), не привязанная к сессии браузера.
- Основной принцип идемпотентности: повторный запуск после паузы/сбоя НЕ создаёт дублей, если элемент уже был перенесён мигратором и имеет `UF_CLOUD_ID`.

## 1. Источник данных (облако)
- Источник: REST API Bitrix24 через входящий webhook вида `https://<portal>/rest/<user>/<token>/...`.
- Получение структуры полей сущностей через методы `crm.*.fields` (например `crm.deal.fields`) для dry run и построения плана переноса.
- Для пользовательских полей (если потребуется точечное создание) ориентироваться на семейство методов `crm.*.userfield.*` (например `crm.deal.userfield.add`).
- Получение данных о пользователях через `user.get`, `user.search` для маппинга и миграции.
- Получение структуры отделов через `department.get`, `department.list` для полного переноса иерархии.
- Получение рабочих групп через `socialnetwork.api.workgroup.list`, `sonet_group.user.list` для миграции проектов/групп.
- Получение воронок через `crm.dealcategory.list` и стадий через методы категорий.

## 2. Сущности в MVP
Обязательные к переносу:
- Сделки
- Лиды
- Контакты
- Компании

Также требуется (как зависимости/содержимое):
- **Структура (отделы)** — перенос полной иерархии отделов и их параметров
- **Пользователи** — перенос сотрудников (с выбором в dry run), синхронизация полей
- **Рабочие группы (Workgroups/Проекты)** — перенос групп, их членов, иерархии
- **Диск (Disk)** — перенос **структуры + файлов** (права/шаринг не переносим)
- **Воронки и стадии сделок** — перенос структуры воронок и маппинг стадий
- **Связи между сущностями** — привязки между контактами, лидами, сделками, компаниями
- Таймлайн CRM (максимально возможный перенос)
- Задачи, связанные с CRM сущностями и workgroups (переносить «всё что можно», лучше отдельной финальной фазой)
- Файлы из:
  - таймлайна
  - задач
  - карточек элементов (если прикреплены)

## 3. Политики "конфликтов" и повторного запуска
### 3.1. "Чистая система"
- Предполагаем, что коробка чистая: если встречается сущность без `UF_CLOUD_ID`, мы её **не трогаем** (skip) и пишем в лог.

### 3.2. "Элемент уже переносился мигратором"
- Если в коробке найден объект с заполненным `UF_CLOUD_ID`, то это "повторный прогон", и поведение определяется настройкой перед запуском миграции:
  - `SKIP` (по умолчанию)
  - `UPDATE` (обновлять поля по данным из облака)
  - `DELETE_AND_RECREATE` (удалить и создать заново)
  - `DUPLICATE` (создать дубль, сохранив старый)
- Настройка задаётся **после dry run**, перед стартом миграции, и сохраняется в State HL-блоке.

## 4. Dry run (обязательный шаг перед миграцией)
Dry run выполняет:
- Проверку подключения к webhook и прав доступа.
- Сбор справочных данных (что доступно для переноса).
- Формирование "плана миграции" (по умолчанию включено всё).
- **Сбор информации о пользователях**: список всех сотрудников из облака, сравнение с уже имеющимися в коробке, выявление новых пользователей.
- **Сбор информации о структуре**: список отделов из облака, их иерархия, параметры.
- **Сбор информации о рабочих группах**: список групп, их типы (public/private/secret), иерархия, члены.
- **Сбор информации о диске**: объёмы (папки/файлы), базовая структура и оценка размера (если доступно через API).
- **Сбор информации о воронках**: список воронок сделок и стадии в каждой воронке.

### 4.1. Что должно быть доступно для выбора (в UI)
После dry run, до "Старт миграции" должно быть UI, где по умолчанию всё включено, но можно отключить:
- **Структура**: чекбокс "переносить отделы", выбор существующих отделов коробки (в случае если не мигрируем)
- **Пользователи**:
  - список новых пользователей (найденных в облаке, но не в коробке)
  - чекбоксы для каждого — "мигрировать или пропустить"
  - опция "мигрировать всех найденных" / "пропустить всех"
  - указание группы по умолчанию для новых пользователей (при миграции)
- **Рабочие группы**:
  - чекбокс "переносить рабочие группы"
  - опция "переносить иерархию групп"
  - опция "переносить права доступа" (опционально, может быть сложно)
- **Диск (Disk)**:
  - режим: `FULL_DISK` / `ATTACHMENTS_ONLY` / `NONE`
  - ограничения по размеру/типам (опционально)
- **Воронки**:
  - список найденных воронок с чекбоксами
  - опция "переносить все воронки" / "пропустить все"
  - для каждой воронки — опция выбора стадий
- Сущности: сделки/лиды/контакты/компании
- Пользовательские поля по каждой сущности (чекбоксы исключения полей)
- Таймлайн: типы событий (если удастся классифицировать)
- Задачи: чекбоксы "переносить комментарии / чек-листы / файлы / …" (если API позволит)
- Файлы: чекбоксы "качать/загружать" (для вложений; для FULL_DISK используется режим Диска)

### 4.2. Результаты dry run (отчёт)
- **Информация о пользователях**:
  - сколько активных пользователей в облаке
  - сколько уже есть в коробке (по email/ФИО)
  - сколько новых пользователей предложено к миграции
  - список новых с их основными данными (ФИО, email, должность, отдел)
- **Информация о структуре**:
  - количество отделов в облаке
  - глубина иерархии
  - наличие отделов с тем же названием в коробке
- **Информация о рабочих группах**:
  - количество групп в облаке по типам (public/private/secret)
  - глубина иерархии групп
  - количество членов в каждой группе
- **Информация о диске**:
  - оценка количества папок/файлов (если возможно)
  - оценка примерного объёма (если возможно)
- **Информация о воронках**:
  - список воронок сделок
  - стадии в каждой воронке
  - количество сделок в каждой стадии (для оценки объёма)
- Количество сущностей к переносу по типам.
- Список пользовательских полей по каждой сущности (и возможность снять галочки).
- Оценка по файлам (кол-во, примерные объёмы если возможно).
- Отчёт по пользователям (для CRM сущностей):
  - сколько пользователей нашли однозначно
  - сколько "не нашли/неоднозначно" → будет создана заглушка

## 5. Перенос структуры (отделы)
(без изменений)

## 6. Перенос пользователей
(без изменений)

## 8. Рабочие группы (Workgroups/Проекты) — НОВОЕ!
(без изменений)

## 15. Хранилище данных (HL-блоки)
(без изменений)

## 16. Стратегия по диску и файлам (коробка) — ОБНОВЛЕНО

### 16.1. Режимы переноса
- `NONE` — не переносим диск и файлы.
- `ATTACHMENTS_ONLY` — переносим только файлы, встречающиеся как вложения (таймлайн/задачи/карточки).
- `FULL_DISK` — переносим весь диск: **структура папок + файлы**, без прав/шаринга.

### 16.2. Общие принципы
- Все файлы сначала выгружаются в папку на **общем диске** (одна корневая папка миграции).
- Копии файлов допустимы (дедупликацию можно сделать позже).
- Права доступа и шаринг **не переносим** (всё создаётся под техническим пользователем/админом).

### 16.3. Структура хранения (для вложений)
Базовая структура хранения:
- `Migrator/Deals/<cloudDealId>/...`
- `Migrator/Leads/<cloudLeadId>/...`
- `Migrator/Contacts/<cloudContactId>/...`
- `Migrator/Companies/<cloudCompanyId>/...`
- `Migrator/Tasks/<cloudTaskId>/...`
- `Migrator/Workgroups/<cloudGroupId>/...`
- `Migrator/Timeline/<cloudEntityType>/<cloudEntityId>/...`

### 16.4. Структура хранения (для FULL_DISK)
- Корневая папка: `Migrator/Disk/`
- Внутри создаём структуру папок, соответствующую источнику, и загружаем файлы.

## 18. Очерёдность (pipeline) миграции — ОБНОВЛЕННАЯ
Фазы (с возможностью паузы между шагами):

1. **Dry run**
2. **Подготовка коробки** (UF-поля, воронки/стадии, HL-блоки)
3. **Перенос структуры (отделы)**
4. **Перенос пользователей**
5. **Перенос рабочих групп**
6. **Перенос диска (Disk)** (в выбранном режиме)
7. **Перенос базовых сущностей CRM**
8. **Восстановление связей между сущностями**
9. **Перенос задач**
10. **Перенос таймлайна и активностей**
11. **Финализация**
