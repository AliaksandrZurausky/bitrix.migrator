# Bitrix Migrator (bitrix_migrator)

Модуль-заготовка для миграции данных Bitrix24 «облако → коробка» с переносом максимально возможной части CRM-таймлайна.

## Цели MVP

- Задать базовую структуру D7-модуля (установка/удаление, автолоад классов).
- Подготовить каркас для очереди/маппингов/логов (позже будет реализовано через HL-блоки).
- Подготовить каркас агента, который будет выполнять миграцию пакетами.

> Важно: в Bitrix стандартный идентификатор модуля обычно имеет вид `vendor.module`. Здесь используется `bitrix_migrator` по требованиям проекта — если будут проблемы с установкой/автолоадом, стоит переименовать в формат с точкой.

## Планируемая архитектура (высокоуровнево)

- **Admin UI**: одна главная страница с вкладками (будет сделано отдельно в «лаборатории»).
- **Application layer**:
  - `TaskRunner`: выполнение пачки задач.
  - `QueueBuilder`: формирование задач в очереди.
- **Integration**:
  - `CloudRestClient`: чтение данных из облака по webhook.
- **Box writers (D7)**:
  - `CrmWriter`: создание/обновление сущностей CRM.
  - `TimelineWriter`: создание записей таймлайна (комментарии/активности).
- **Storage (HL)**:
  - `QueueRepository`: очередь задач.
  - `MapRepository`: соответствия cloud_id → box_id.
  - `LogRepository`: журналирование.

## Структура репозитория

Репозиторий содержит **содержимое** папки модуля (без внешней обёртки). При разворачивании на сервере Битрикс предполагается путь вида:

- `/local/modules/bitrix_migrator/` (или `/bitrix/modules/bitrix_migrator/` — зависит от проекта)

Ключевые файлы:

- `install/index.php` — класс модуля и логика установки/удаления.
- `install/version.php` — версия модуля.
- `include.php` — регистрация автолоада классов.
- `lib/` — код модуля (D7/PSR-подобная структура).

## Агент (как будет работать)

Агент будет зарегистрирован при установке модуля и будет регулярно запускаться (через cron-режим агентов).

Принцип:

1. Агент читает из очереди (HL) N задач.
2. Выполняет их, обновляет статусы/ошибки.
3. Возвращает строку с самим собой для повторного выполнения.

Каркас агента уже добавлен: `BitrixMigrator\Agent\MigratorAgent::run()`.

## Дальнейшие шаги

- Добавить HL-блоки на установке (Queue/Map/Log) и репозитории для них.
- Добавить CloudRestClient + обёртки над методами REST.
- Реализовать первый рабочий сценарий: перенос сделок + перенос комментариев таймлайна.
